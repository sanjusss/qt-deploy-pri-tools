name: Build

on:
  pull_request:
    branches: 'master'
    paths:
      - "**"
      - "!**.MD"
      - "!LICENSE"
      - "!.gitignore"
  push:
    branches: 'master'
    tags: 'v*'
    paths:
      - "**"
      - "!**.MD"
      - "!LICENSE"
      - "!.gitignore"

jobs:
  build:

    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        path: "src" 
      
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 2.2.108
      
    - name: Build with dotnet
      run: dotnet build --configuration Release src
    
    - name: Create artifact
      if: always() && !startsWith(github.event_name, 'pull_request')
      uses: actions/upload-artifact@v1.0.0
      with:
        name: create-lib-reference
        path: src/create-lib-reference/bin/Release/create-lib-reference.exe
    
    - name: Upload release
      if: always() && startsWith(github.ref, 'refs/tags/v')
      uses: yakuhzi/action-release@v1
      with:
        file: src/create-lib-reference/bin/Release/create-lib-reference.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  

    - name: Checkout pri
      if: always() && !startsWith(github.event_name, 'pull_request')
      uses: actions/checkout@v2
      with:
        path: "pri"
        repository: sanjusss/qt-deploy-pri
    
    - name: Modify pri
      if: always() && !startsWith(github.event_name, 'pull_request')
      run: |
        ls -l ./src/create-lib-reference/bin/Release/
        ls -l ./pri/tools/
        rm ./pri/tools/create-lib-reference.exe
        ls -l ./pri/tools/
        cp ./src/create-lib-reference/bin/Release/create-lib-reference.exe ./pri/tools/
        ls -l ./pri/tools/
      shell: bash
    
    - uses: EndBug/add-and-commit@v2
      if: always() && !startsWith(github.event_name, 'pull_request')
      with:
        message: "Update create-lib-reference."
        path: "."
        pattern: "*.exe"
        cwd: "./src/"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
